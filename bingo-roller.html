<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="$BINGO Roller - Epic bingo game for live streams on BingoXRPL!" />
  <title>$BINGO Roller - BingoXRPL Live Tool</title>

  <!-- Google Tag Manager (kept as requested) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-H99K0B4L10"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-H99K0B4L10');
  </script>

  <!-- Firebase (kept) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    /* ========== Core layout & theme (enhanced for better sizing/placement) ========== */
    :root {
      --bg: #0A0F2A;
      --accent: #00B8D9;
      --glow: #00FF00;
      --card-bg: #1A1F3A;
      --muted: rgba(255,255,255,0.06);
    }
    html,body { height:100%; }
    body {
      font-family: 'Arial', Helvetica, sans-serif;
      background: var(--bg);
      color: #FFF;
      margin:0;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    header {
      background: var(--accent);
      padding: clamp(0.8rem, 2vw, 1.2rem);
      position: sticky;
      top:0;
      z-index:100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }
    .header-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 1.25rem;
      gap: 1rem;
    }
    h1 { margin:0; color:#000; font-size: clamp(1.5rem, 3.2vw, 2.6rem); }
    nav .nav-menu { display:flex; gap:1rem; list-style:none; margin:0; padding:0; align-items:center; }
    nav .nav-menu a { color:#000; font-weight:700; text-decoration:none; }

    .container {
      max-width: 1200px;
      margin: clamp(1rem, 2vw, 2rem) auto;
      padding: 0 1rem;
    }

    /* Buttons & controls (improved spacing) */
    button { cursor:pointer; border: none; background: var(--accent); color:#000; padding: .75rem 1.25rem; border-radius: 10px; font-weight:700; }
    button:active{ transform: translateY(1px); }
    select, input { padding:.6rem .8rem; border-radius:8px; border: 1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color: #fff; }
    #roll-button { background:#FF0000; color:#fff; padding: 1rem 2rem; border-radius: 999px; font-size: clamp(1.2rem, 3vw, 1.8rem); box-shadow: 0 6px 14px rgba(255,0,0,0.35); }
    #roll-button:hover{ transform:scale(1.03); background: #00FF00; color:#000; }

    /* Result preview: fixed size, no jumps */
    #result {
      font-size: clamp(1.6rem, 3.6vw, 2.4rem);
      color: var(--glow);
      text-shadow: 0 2px 12px rgba(0,255,0,0.35);
      margin: 1rem 0;
      height: 3.2rem;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      white-space:nowrap;
    }

    /* Bingo Board: enhanced with animation on call */
    .bingo-board {
      display: grid;
      grid-template-columns: repeat(10, minmax(40px, 1fr));
      gap: clamp(.5rem, 1vw, 1rem);
      justify-items: center;
      max-width: min(98vw, 1000px);
      margin: 1.5rem auto;
    }
    .bingo-board .header { grid-column: span 2; color: var(--glow); font-weight:800; font-size: clamp(1rem, 1.8vw, 1.6rem); text-align:center; }
    .bingo-board .cell {
      width:100%;
      aspect-ratio: 1/1;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:50%;
      background: var(--card-bg);
      color: var(--accent);
      font-size: clamp(.95rem, 1.4vw, 1.2rem);
      box-sizing: border-box;
      transition: background .3s ease, color .3s ease, box-shadow .3s ease, transform .3s ease;
    }
    .bingo-board .cell.called {
      background: var(--glow);
      color: #000;
      box-shadow: 0 0 12px rgba(0,255,0,0.25);
      transform: scale(1.05);
    }

    /* Player card / player list styles (improved) */
    .player-card { display:grid; grid-template-columns:repeat(5,1fr); gap:.6rem; max-width: min(80vw,600px); margin: 1rem auto; padding: 1rem; border: 2px solid var(--glow); border-radius:10px; }
    .player-card .cell { aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; background:var(--card-bg); color:var(--accent); border-radius:8px; transition: background .3s ease, transform .3s ease; }
    .player-card .cell.free { background:#FF0000; color:#FFF; font-weight:800; }
    .player-card .cell.called { background: var(--glow); color: #000; transform: scale(1.05); }

    /* Win pattern preview (larger, better visibility) */
    .win-pattern {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: .8rem;
      max-width: 400px;
      margin: 1.5rem auto;
      padding: .8rem;
      border-radius: 12px;
      background: rgba(255,255,255,0.02);
    }
    .win-pattern .cell { aspect-ratio:1/1; background:var(--card-bg); border-radius:8px; opacity:.3; transition: opacity .3s ease, box-shadow .3s ease; }
    .win-pattern .cell.win { background: var(--glow); opacity:1; box-shadow: 0 0 8px rgba(0,255,0,0.15); }

    /* Draggable player list: fixed to viewport, no rotation widget */
    #player-list {
      position: fixed;
      right: 20px;
      top: 80px;
      width: clamp(200px, 18vw, 320px);
      background: rgba(0,0,0,0.6);
      padding: 0.6rem;
      border-radius: 10px;
      border: 2px solid var(--glow);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      z-index: 9999;
      cursor: grab;
      user-select: none;
      transform: translate(0,0);
      touch-action: none;
    }
    #player-list h3 { margin:0 0 .4rem 0; color:var(--glow); font-size:1rem; }
    #player-list-content { max-height: 60vh; overflow-y:auto; padding-right:6px; }
    .player-item { padding:6px 8px; display:flex; justify-content:space-between; align-items:center; gap:8px; border-bottom: 1px solid rgba(255,255,255,0.03); color:#fff; font-weight:600; }
    .player-item .cardid{ color:var(--glow); font-weight:800; }

    /* Host controls layout (centered, better flow) */
    #host-controls { display: flex; flex-direction: column; align-items: center; gap: 1rem; }

    /* small screens */
    @media (max-width:767px) {
      .container { padding: 0 12px; }
      #player-list { position: static; width: 100%; right:auto; top:auto; transform:none; margin: 1rem 0; cursor:default; }
      .bingo-board { grid-template-columns: repeat(10, minmax(30px, 1fr)); gap: .3rem; }
      .win-pattern { max-width: 300px; gap: .6rem; }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <h1>$BINGO</h1>
      <nav>
        <ul class="nav-menu">
          <li><a href="https://bingoxrp.com/" aria-label="Go to Home">Home</a></li>
          <li><a href="https://bingoxrp.com/#buy">How to Trade</a></li>
          <li><a href="https://bingoxrp.com/#nft">NFT Collection</a></li>
          <li><a href="https://bingoxrp.com/#community">Community</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="container">
    <h1>$BINGO Roller</h1>
    <p class="tagline">Roll epic $BINGO numbers during your live streams!</p>

    <div style="display: flex; justify-content: center; gap: 1rem;">
      <button id="host-mode">Host a Game</button>
      <button id="player-mode">Join as Player</button>
    </div>

    <!-- Host Controls (refined layout) -->
    <div id="host-controls" style="display:none; margin-top:1.5rem;">
      <div style="display:flex; gap:.8rem; align-items:center; justify-content:center; flex-wrap:wrap;">
        <label for="game-type" style="font-weight:700;">Select Game Type:</label>
        <select id="game-type" aria-label="Select Bingo Game Type">
          <option value="singleLine">Single Line (Any Line)</option>
          <option value="perimeter">Perimeter</option>
          <option value="xShape">X-Shape</option>
          <option value="fourCorners">Four Corners</option>
          <option value="fullCard">Full Card</option>
        </select>
      </div>

      <div id="win-pattern" class="win-pattern" aria-hidden="false"></div>

      <div style="display:flex; gap:1.2rem; justify-content:center; margin-top:1.2rem; align-items:center; flex-wrap:wrap;">
        <button id="roll-button" aria-label="Roll a new bingo number">Roll!</button>
        <div id="result" role="status" aria-live="polite" aria-atomic="true"></div>
        <button id="reset-button" aria-label="Reset the bingo game">Reset Game</button>
      </div>

      <div style="display:flex; gap:1rem; justify-content:center; margin-top:1rem; align-items:center; flex-wrap:wrap;">
        <div id="game-id-display">Game ID: Loading...</div>
        <button id="copy-game-id">Copy Game ID</button>
      </div>

      <div id="leaderboard" style="margin-top:1.5rem; text-align:center;"></div>
    </div>

    <!-- Player Controls -->
    <div id="player-controls" style="display:none; margin-top:1.5rem; text-align:center;">
      <input id="x-handle-input" type="text" placeholder="Enter your X Handle (e.g., @UserX)" aria-label="X Handle" style="margin-bottom:1rem;" />
      <input id="game-id-input" type="text" placeholder="Enter Game ID" aria-label="Game ID" style="margin-bottom:1rem;" />
      <button id="join-game-button">Join Game & Generate Card</button>
      <div id="player-card" class="player-card" aria-hidden="true"></div>
    </div>

    <h2 style="margin-top:2.5rem; text-align:center;">Game Board (Called Numbers)</h2>
    <div id="bingo-board" class="bingo-board" aria-hidden="false"></div>

  </div>

  <!-- Floating Player List (draggable, no widget) -->
  <div id="player-list" aria-hidden="true" style="display:none;">
    <h3>Player List</h3>
    <div id="player-list-content"></div>
  </div>

  <footer style="padding:1.2rem; text-align:center; color:#AAA;">
    <div class="container">
      <p>&copy; 2025 BingoXRPL. All rights reserved. This is a memecoin – DYOR and invest responsibly. Not financial advice.</p>
      <div style="margin-top:.5rem;">
        <a href="https://x.com/BingoXRPL" target="_blank" style="color:#AAA;">X</a> |
        <a href="https://discord.com/invite/ZSQzZd2bPg" target="_blank" style="color:#AAA;">Discord</a> |
        <a href="https://t.me/bingoonxrp" target="_blank" style="color:#AAA;">Telegram</a>
      </div>
    </div>
  </footer>

  <!-- ========== Script: logic & firebase (fixed & enhanced) ========== -->
  <script>
    // Firebase setup (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyDFX2YygpK6ELMXwJZwZ3tnmT-DfLge2Sc",
      authDomain: "bingoxrpl.firebaseapp.com",
      databaseURL: "https://bingoxrpl-default-rtdb.firebaseio.com",
      projectId: "bingoxrpl",
      storageBucket: "bingoxrpl.firebasestorage.app",
      messagingSenderId: "1032944729350",
      appId: "1:1032944729350:web:77c0cc92c59dce214d3287",
      measurementId: "G-H99K0B4L10"
    };
    firebase.initializeApp(firebaseConfig);
    const analytics = firebase.analytics();
    const database = firebase.database();
    const auth = firebase.auth();

    // Constants & state
    const letters = ['B','I','N','G','O'];
    const ranges = { B:[1,15], I:[16,30], N:[31,45], G:[46,60], O:[61,75] };
    const gamePatterns = {
      singleLine:[[0,0,0,0,0],[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0],[0,0,0,0,0]],  // Example: middle row; adjust if any line
      perimeter:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],
      xShape:[[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[1,0,0,0,1]],
      fourCorners:[[1,0,0,0,1],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[1,0,0,0,1]],
      fullCard:[[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1]]
    };

    let calledNumbers = new Set();
    let isHost = false;
    let gameId = null;
    let playerCard = null;
    let xHandle = localStorage.getItem('xHandle') || null;
    let gameRef = null;
    let gameType = 'singleLine';
    let playerWins = JSON.parse(localStorage.getItem('playerWins') || '{}');
    const notifiedWinners = new Set();
    const displayedPlayers = new Set();
    let playersArray = [];

    // DOM refs
    const hostModeBtn = document.getElementById('host-mode');
    const playerModeBtn = document.getElementById('player-mode');
    const hostControls = document.getElementById('host-controls');
    const playerControls = document.getElementById('player-controls');
    const gameIdDisplay = document.getElementById('game-id-display');
    const gameIdInput = document.getElementById('game-id-input');
    const xHandleInput = document.getElementById('x-handle-input');
    const joinGameBtn = document.getElementById('join-game-button');
    const rollButton = document.getElementById('roll-button');
    const resetButton = document.getElementById('reset-button');
    const gameTypeSelect = document.getElementById('game-type');
    const copyGameIdBtn = document.getElementById('copy-game-id');
    const resultDiv = document.getElementById('result');
    const playerListEl = document.getElementById('player-list');
    const playerListContent = document.getElementById('player-list-content');

    // ---------- Utility helpers ----------
    function getRandomNumber(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function isValidCalledFormat(str){ return typeof str === 'string' && /^(?:B|I|N|G|O)-\d{1,2}$/.test(str); }

    // ---------- Board creation ----------
    function createBoard(){
      const board = document.getElementById('bingo-board');
      if(!board) return;
      board.innerHTML = '';
      letters.forEach(l=>{
        const header = document.createElement('div');
        header.textContent = l;
        header.className = 'header';
        board.appendChild(header);
      });
      for(let i=0;i<15;i++){
        letters.forEach(letter=>{
          const [min] = ranges[letter];
          const num = min + i;
          const div = document.createElement('div');
          div.textContent = num;
          div.className = 'cell';
          div.id = `${letter}-${num}`;
          if(calledNumbers.has(`${letter}-${num}`)) div.classList.add('called');
          board.appendChild(div);
        });
      }
    }

    // ---------- Win pattern preview ----------
    function displayWinPattern(){
      const winPatternDiv = document.getElementById('win-pattern');
      winPatternDiv.innerHTML = '';
      const pattern = gamePatterns[gameType] || gamePatterns.singleLine;
      for(let r=0;r<5;r++){
        for(let c=0;c<5;c++){
          const cell = document.createElement('div');
          cell.className = 'cell';
          if(pattern[r][c]) cell.classList.add('win');
          winPatternDiv.appendChild(cell);
        }
      }
    }

    // ---------- Player card generation & display ----------
    function generatePlayerCard(){
      const card = { B:[], I:[], N:[], G:[], O:[] };
      letters.forEach(letter=>{
        const [min,max]=ranges[letter];
        const arr=[];
        while(arr.length<5){
          const n=getRandomNumber(min,max);
          if(!arr.includes(n)) arr.push(n);
        }
        card[letter]=arr.sort((a,b)=>a-b);
      });
      card.N[2] = 'FREE';
      localStorage.setItem('playerCard', JSON.stringify(card));
      return card;
    }
    function computeCardID(card){
      let sum=0,product=1;
      letters.forEach(letter=>{
        card[letter].forEach(num=>{
          if(num!=='FREE'){ sum+=num; product=(product*num)%1000000; }
        });
      });
      const combined=(sum*31 + product) % 1000;
      return combined.toString().padStart(3,'0');
    }
    function displayPlayerCard(){
      const cardDiv = document.getElementById('player-card');
      if(!cardDiv || !playerCard) return;
      cardDiv.innerHTML = '';
      letters.forEach(l=>{
        const header = document.createElement('div');
        header.className = 'header';
        header.textContent = l;
        cardDiv.appendChild(header);
      });
      for(let r=0;r<5;r++){
        letters.forEach(letter=>{
          const num = playerCard[letter][r];
          const el = document.createElement('div');
          el.className = 'cell';
          el.textContent = num;
          el.id = `player-${letter}-${num}`;
          if(num === 'FREE') el.classList.add('free', 'called');
          if(calledNumbers.has(`${letter}-${num}`)) el.classList.add('called');
          cardDiv.appendChild(el);
        });
      }
    }

    // ---------- Highlight called numbers ----------
    function highlightNumber(letter, number){
      try {
        const id = `${letter}-${number}`;
        const boardCell = document.getElementById(id);
        if(boardCell) boardCell.classList.add('called');
        const playerCell = document.getElementById(`player-${letter}-${number}`);
        if(playerCell) playerCell.classList.add('called');
        resultDiv.textContent = `${letter}-${number}`;
      } catch(e){
        console.error('Highlight error', e);
      }
    }

    // ---------- NEW: Bingo check logic (on player side) ----------
    function checkForBingo() {
      if (!playerCard || !gamePatterns[gameType]) return false;
      const pattern = gamePatterns[gameType];
      let isWin = true;
      for (let r = 0; r < 5; r++) {
        for (let c = 0; c < 5; c++) {
          if (pattern[r][c] === 1) {
            const letter = letters[c];
            const num = playerCard[letter][r];
            if (num !== 'FREE' && !calledNumbers.has(`${letter}-${num}`)) {
              isWin = false;
              break;
            }
          }
        }
        if (!isWin) break;
      }
      return isWin;
    }

    // ---------- Roll logic ----------
    function rollBingo(){
      if(calledNumbers.size >= 75){ showToast('All numbers called',3000); return null; }
      let letter,number,attempts=0;
      do {
        letter = letters[Math.floor(Math.random()*letters.length)];
        const [min,max] = ranges[letter];
        number = getRandomNumber(min,max);
        attempts++;
        if(attempts>200){ showToast('Unable to find new number',4000); return null; }
      } while(calledNumbers.has(`${letter}-${number}`));
      const rolled = `${letter}-${number}`;
      calledNumbers.add(rolled);
      if(gameRef && isHost){
        gameRef.child('called').push(rolled).catch(err=>console.error('DB push error',err));
      } else {
        localStorage.setItem('calledNumbers', JSON.stringify([...calledNumbers]));
        highlightNumber(letter, number);
      }
      return rolled;
    }

    // ---------- Toast utility (enhanced for modals on wins) ----------
    function showToast(msg, duration=2500, isWin=false){
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      Object.assign(t.style, { position:'fixed', right:'20px', top:'20px', padding:'10px 14px', background: isWin ? '#FFD700' : 'var(--glow)', color:'#000', zIndex:99999, borderRadius:'8px', boxShadow:'0 8px 30px rgba(0,0,0,0.4)', fontWeight:800 });
      document.body.appendChild(t);
      setTimeout(()=> t.style.opacity = '1', 20);
      setTimeout(()=> { t.style.opacity='0'; setTimeout(()=> t.remove(),300); }, duration);
    }

    // ---------- Leaderboard ----------
    function updateLeaderboardSnapshot(winnersObj){
      const lb = document.getElementById('leaderboard');
      lb.innerHTML = '<h3 style="color:var(--glow)">Winners</h3>';
      if(!winnersObj || Object.keys(winnersObj).length===0){ lb.innerHTML += '<p style="color:#AAA">No winners yet.</p>'; return; }
      const ul = document.createElement('ul');
      ul.style.listStyle='none'; ul.style.padding='0';
      Object.keys(winnersObj).forEach(k=>{
        const v = winnersObj[k];
        const li = document.createElement('li'); li.textContent = `${v.handle} at ${new Date(v.timestamp).toLocaleString()} (${v.gameType})`;
        ul.appendChild(li);
      });
      lb.appendChild(ul);
    }
    function appendWinnerToLeaderboard(key, value){
      const lb = document.getElementById('leaderboard');
      if(!lb.querySelector('ul')){ const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0'; lb.appendChild(ul); }
      const ul = lb.querySelector('ul');
      const li = document.createElement('li'); li.textContent = `${value.handle} at ${new Date(value.timestamp).toLocaleString()} (${value.gameType})`;
      ul.appendChild(li);
    }

    // ---------- Player list (no duplicates, no rotation) ----------
    function updatePlayerListSnapshot(playersObj){
      playerListContent.innerHTML = '';
      playersArray = [];
      if(!playersObj || Object.keys(playersObj).length===0){
        playerListContent.innerHTML = '<p style="color:#AAA;margin:6px 0;">No players yet.</p>';
        return;
      }
      const keys = Object.keys(playersObj).sort();
      keys.forEach(k=>{
        const p = playersObj[k];
        const handle = p.handle || ('@'+k);
        const cardID = p.cardID || 'N/A';
        if (playersArray.some(player => player.key === k)) return; // Skip dupes
        playersArray.push({key:k,handle,cardID});
        const div = document.createElement('div'); div.className = 'player-item';
        const left = document.createElement('div'); left.textContent = handle;
        const right = document.createElement('div'); right.className = 'cardid'; right.textContent = `#${cardID}`;
        div.appendChild(left); div.appendChild(right);
        playerListContent.appendChild(div);
      });
    }
    function appendPlayerToList(key, value){
      if(!playerListContent) return;
      if (displayedPlayers.has(key) || playersArray.some(p => p.key === key)) return; // Prevent dupes
      if(playerListContent.textContent.includes('No players yet.')) playerListContent.innerHTML = '';
      const handle = value.handle || ('@'+key);
      const cardID = value.cardID || 'N/A';
      const div = document.createElement('div'); div.className = 'player-item';
      const left = document.createElement('div'); left.textContent = handle;
      const right = document.createElement('div'); right.className='cardid'; right.textContent = `#${cardID}`;
      div.appendChild(left); div.appendChild(right);
      playerListContent.appendChild(div);
      playersArray.push({key,handle,cardID});
      if(isHost) showToast(`${handle} joined`,2500);
    }

    // ---------- Setup / cleanup firebase listeners ----------
    let gameListeners = { called: false, gameType: false, winners:false, players:false };
    function cleanupListeners(){
      if(gameRef){
        try {
          gameRef.child('called').off();
          gameRef.child('gameType').off();
          gameRef.child('winners').off();
          gameRef.child('players').off();
        } catch(e){ /* ignore */ }
      }
      gameListeners = { called:false, gameType:false, winners:false, players:false };
    }

    function setupGame(id){
      try {
        cleanupListeners();
        gameRef = database.ref(`games/${id}`);
        // Initial called snapshot
        gameRef.child('called').once('value', snap=>{
          calledNumbers.clear();
          const obj = snap.val();
          if(obj){ Object.values(obj).forEach(v=> { if(isValidCalledFormat(v)) calledNumbers.add(v); }); }
          localStorage.setItem('calledNumbers', JSON.stringify([...calledNumbers]));
          createBoard(); // Rebuild to apply all called
          if (!isHost) displayPlayerCard(); // Re-apply for player card
        });
        // New called numbers
        gameRef.child('called').on('child_added', snap=>{
          const rolled = snap.val();
          if(!isValidCalledFormat(rolled)) return;
          const [letter, num] = rolled.split('-');
          calledNumbers.add(rolled);
          localStorage.setItem('calledNumbers', JSON.stringify([...calledNumbers]));
          highlightNumber(letter, num);
          if (!isHost) {
            displayPlayerCard(); // Ensure player card updates
            if (checkForBingo() && !playerWins[gameType]) {
              playerWins[gameType] = true;
              localStorage.setItem('playerWins', JSON.stringify(playerWins));
              gameRef.child('winners').push({
                handle: xHandle,
                timestamp: Date.now(),
                gameType: gameType
              }).catch(err => console.error('Win push error', err));
              showToast('BINGO! You won!', 5000, true);
            }
          }
        });

        // Game type
        gameRef.child('gameType').on('value', snap=>{
          const newGameType = snap.val() || 'singleLine';
          gameType = newGameType;
          if(isHost) gameTypeSelect.value = gameType;
          displayWinPattern();
          if (!isHost) checkForBingo(); // Re-check on type change
        });

        // Winners
        gameRef.child('winners').once('value', snap=>{
          const obj = snap.val() || {};
          updateLeaderboardSnapshot(obj);
        });
        gameRef.child('winners').on('child_added', snap=>{
          const key = snap.key, val = snap.val();
          if(!notifiedWinners.has(key)){
            notifiedWinners.add(key);
            appendWinnerToLeaderboard(key,val);
            if(isHost) showToast(`BINGO! ${val.handle} won (${val.gameType})!`,4000);
            if(!isHost && val.handle === xHandle) showToast('BINGO! You won!',5000, true);
          }
        });

        // Players
        gameRef.child('players').once('value', snap=>{
          const obj = snap.val() || {};
          updatePlayerListSnapshot(obj);
        });
        gameRef.child('players').on('child_added', snap=>{
          const key = snap.key, val = snap.val();
          if(!displayedPlayers.has(key)){
            displayedPlayers.add(key);
            appendPlayerToList(key,val);
          }
        });

      } catch(e){
        console.error('Setup game error:', e);
        showToast('Error setting up game', 3000);
      }
    }

    // ---------- Event handlers ----------
    hostModeBtn.addEventListener('click', ()=>{
      auth.signInAnonymously().then(()=>{
        isHost = true;
        hostControls.style.display = 'block';
        playerControls.style.display = 'none';
        playerListEl.style.display = 'block';
        calledNumbers.clear();
        localStorage.removeItem('calledNumbers');
        notifiedWinners.clear();
        displayedPlayers.clear();
        playersArray = [];
        playerWins = {};
        localStorage.setItem('playerWins', JSON.stringify(playerWins));
        gameId = Math.random().toString(36).substring(2,10);
        localStorage.setItem('gameId', gameId);
        gameIdDisplay.textContent = `Game ID: ${gameId} (Share this!)`;
        setupGame(gameId);
        gameType = gameTypeSelect.value;
        if(gameRef) gameRef.child('gameType').set(gameType).catch(err=>console.error(err));
        displayWinPattern();
        createBoard();
        showToast('Host mode enabled. New game created.',3000);
      }).catch(err=>{
        console.error('Auth error for host:', err);
        showToast('Failed to authenticate for host mode', 3000);
      });
    });

    playerModeBtn.addEventListener('click', ()=>{
      isHost = false;
      hostControls.style.display = 'none';
      playerControls.style.display = 'block';
      playerListEl.style.display = 'none';
      const stored = JSON.parse(localStorage.getItem('calledNumbers') || '[]');
      calledNumbers = new Set(stored);
      createBoard();
      displayWinPattern();
      showToast('Player mode: enter game ID and handle to join.',2500);
    });

    joinGameBtn.addEventListener('click', ()=>{
      const providedGameId = gameIdInput.value.trim();
      const providedHandle = xHandleInput.value.trim();
      if(!providedGameId) return showToast('Enter a valid Game ID', 3000);
      if(!providedHandle || !providedHandle.startsWith('@')) return showToast('Enter a valid X Handle (e.g., @UserX)', 3000);
      auth.signInAnonymously().then(()=>{
        gameId = providedGameId;
        xHandle = providedHandle;
        localStorage.setItem('gameId', gameId);
        localStorage.setItem('xHandle', xHandle);
        playerCard = generatePlayerCard();
        const cardID = computeCardID(playerCard);
        playerWins = {};
        localStorage.setItem('playerWins', JSON.stringify(playerWins));
        displayPlayerCard();
        const handleKey = xHandle.replace('@','');
        gameRef = database.ref(`games/${gameId}`);
        gameRef.child('players').child(handleKey).set({
          handle: xHandle,
          cardID: cardID
        }).then(()=>{
          showToast(`Joined ${gameId} as ${xHandle}`,3000);
          setupGame(gameId);
        }).catch(err=>{
          console.error('Error registering player:', err);
          showToast('Error joining game', 3000);
        });
      }).catch(err=>{
        console.error('Auth error for player join:', err);
        showToast('Failed to authenticate', 3000);
      });
    });

    copyGameIdBtn.addEventListener('click', ()=>{
      if(!gameId) return showToast('No Game ID to copy',2000);
      navigator.clipboard.writeText(gameId).then(()=> showToast('Game ID copied!',2000)).catch(e => showToast('Error copying',2000));
    });

    rollButton.addEventListener('click', ()=>{
      if(!isHost || !gameRef) return showToast('Host a game first', 3000);
      const rolled = rollBingo();
      if(rolled){
        const [L,N] = rolled.split('-');
        highlightNumber(L,N);
      }
    });

    resetButton.addEventListener('click', ()=>{
      if(gameRef && isHost){
        gameRef.remove().catch(err=>console.warn('Failed to remove game:', err));
      }
      cleanupListeners();
      calledNumbers.clear();
      localStorage.removeItem('calledNumbers');
      localStorage.removeItem('playerCard');
      localStorage.removeItem('playerWins');
      playerCard = null;
      playerWins = {};
      notifiedWinners.clear();
      displayedPlayers.clear();
      playersArray = [];
      resultDiv.textContent = '';
      createBoard();
      playerListContent.innerHTML = '';
      document.getElementById('leaderboard').innerHTML = '';
      hostControls.style.display='none';
      playerControls.style.display='none';
      gameId = null;
      localStorage.removeItem('gameId');
      localStorage.removeItem('xHandle');
      xHandle = null;
      gameRef = null;
      showToast('Game reset complete',2000);
    });

    gameTypeSelect.addEventListener('change', ()=>{
      const val = gameTypeSelect.value;
      if(!Object.keys(gamePatterns).includes(val)) return;
      gameType = val;
      if(isHost && gameRef) gameRef.child('gameType').set(gameType).catch(err=>console.error(err));
      displayWinPattern();
      if (!isHost) checkForBingo(); // Re-check for player
    });

    // Auto-join via URL
    (function checkUrlAutoJoin(){
      const urlParams = new URLSearchParams(window.location.search);
      const urlGameId = urlParams.get('gameId');
      if(urlGameId){
        gameId = urlGameId;
        localStorage.setItem('gameId', gameId);
        playerModeBtn.click();
        gameIdInput.value = gameId;
        showToast('Auto-join game ID detected',2000);
      }
    })();

    // Init
    (function init(){
      const stored = JSON.parse(localStorage.getItem('calledNumbers') || '[]');
      calledNumbers = new Set(stored);
      createBoard();
      displayWinPattern();
      const savedX = parseFloat(localStorage.getItem('playerListTransformX') || '0');
      const savedY = parseFloat(localStorage.getItem('playerListTransformY') || '0');
      playerListEl.style.transform = `translate(${savedX}px, ${savedY}px)`;
    })();

    // Dragging logic (unchanged)
    (function makePlayerListDraggable(){
      const el = playerListEl;
      let dragging = false, startX=0, startY=0, currentX=0, currentY=0, startTransform = {x:0,y:0};
      const savedX = parseFloat(localStorage.getItem('playerListTransformX') || '0');
      const savedY = parseFloat(localStorage.getItem('playerListTransformY') || '0');
      currentX = savedX; currentY = savedY;
      el.style.transform = `translate(${currentX}px, ${currentY}px)`;

      function onDown(e){
        if(window.innerWidth < 768) return;
        dragging = true;
        el.style.cursor = 'grabbing';
        const client = (e.touches && e.touches[0]) || e;
        startX = client.clientX;
        startY = client.clientY;
        startTransform.x = currentX;
        startTransform.y = currentY;
        e.preventDefault();
      }
      function onMove(e){
        if(!dragging) return;
        const client = (e.touches && e.touches[0]) || e;
        const dx = client.clientX - startX;
        const dy = client.clientY - startY;
        let nx = startTransform.x + dx;
        let ny = startTransform.y + dy;
        const rect = el.getBoundingClientRect();
        const maxX = window.innerWidth - rect.width - 6;
        const maxY = window.innerHeight - rect.height - 6;
        nx = Math.max(0, Math.min(nx, maxX));
        ny = Math.max(0, Math.min(ny, maxY));
        currentX = nx; currentY = ny;
        el.style.transform = `translate(${currentX}px, ${currentY}px)`;
      }
      function onUp(){
        if(!dragging) return;
        dragging = false;
        el.style.cursor = 'grab';
        localStorage.setItem('playerListTransformX', String(currentX));
        localStorage.setItem('playerListTransformY', String(currentY));
      }
      el.addEventListener('mousedown', onDown);
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
      el.addEventListener('touchstart', onDown, {passive:false});
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('touchend', onUp);
    })();

    firebase.auth().onAuthStateChanged(user => { /* track if needed */ });
    window._bingoState = () => ({ gameId, isHost, gameType, calledCount: calledNumbers.size });
  </script>
</body>
</html>
